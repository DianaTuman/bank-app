global:
  domain: bank-app.local # Example domain for ingress

############################################# POSTGRES #############################################

accounts-db:
  enabled: true
  auth:
    database: practicum
    username: accounts_user
    password: "changeM3Customer!" # Example: Not recommended for production
  primary:
    persistence:
      enabled: true
      size: 1Gi

############################################# KEYCLOAK #############################################

bank-keycloak:
  auth:
    adminUser: admin
    adminPassword: admin

  postgresql:
    enabled: true
    auth:
      username: bn_keycloak
      password: bn_keycloak
      database: bitnami_keycloak

  extraEnvVars:
    - name: KEYCLOAK_ADMIN
      value: admin
    - name: KEYCLOAK_ADMIN_PASSWORD
      value: admin
    - name: KEYCLOAK_EXTRA_ARGS
      value: "--import-realm"

  extraVolumes:
    - name: realm-config
      configMap:
        name: keycloak-realm-config

  extraVolumeMounts:
    - name: realm-config
      mountPath: /opt/bitnami/keycloak/data/import
      readOnly: true

############################################# KAFKA #############################################

bank-kafka:
  replicaCount: 3

  kraft:
    enabled: true

  auth:
    enabled: false

  listeners:
    client:
      protocol: 'PLAINTEXT'
    controller:
      protocol: 'PLAINTEXT'

  externalAccess:
    enabled: false

  persistence:
    enabled: false

  provisioning:
    enabled: true
    topics:
      - name: bank-app.rates
        partitions: 1
        replicationFactor: 3
      - name: bank-app.notifications
        partitions: 1
        replicationFactor: 3
      - name: bank-app.logs
        partitions: 1
        replicationFactor: 3

  controller:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi

  broker:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi

############################################# ZIPKIN #############################################

bank-zipkin:
  enabled: true
  service:
    type: ClusterIP
    port: 9411

  cassandra:
    enabled: false
    tls:
      enabled: false
      autoGenerated:
        enabled: false

  storageType: memory

  persistence:
    enabled: false

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

  ingress:
    enabled: true
    hostname: zipkin.bank-app.local
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/rewrite-target: /

############################################# ELK #############################################

bank-elasticsearch:
  security:
    enabled: false

  service:
    type: ClusterIP
    port: 9200

  persistence:
    enabled: false

  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1
      memory: 2Gi

bank-logstash:
  enabled: true
  persistence:
    enabled: false
  input:
    kafka {
      bootstrap_servers => "bank-app-bank-kafka:9092"
      topics => ["bank-app.logs"]
      group_id => "bank-app"
      decorate_events => extended
    }
  filter:
    mutate {
      copy => { "[@metadata][kafka][timestamp]" => "kafka_timestamp"
                "[@metadata][kafka][partition]" => "partition" }
    }
  output:
    elasticsearch {
      hosts => ["https://bank-app-bank-elasticsearch:9200"]
      index => "bank-logs-%{+YYYY.MM.dd}"
    }

bank-kibana:
  replicaCount: 1
  elasticsearch:
    hosts: ["bank-app-bank-elasticsearch"]
    port: 9200
    security:
      auth:
        enabled: false
    tls:
      enabled: false

  resources:
    requests:
      memory: 512Mi
      cpu: 250m
    limits:
      memory: 1Gi
      cpu: 500m

  ingress:
    enabled: true
    hostname: kibana.bank-app.local
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/rewrite-target: /

############################################# Prometheus #############################################

bank-prometheus:
  prometheus-node-exporter:
    enabled: false
  kube-state-metrics:
    enabled: false
  prometheus-pushgateway:
    enabled: false
  persistentVolume:
    enabled: false
  server:
    persistentVolume:
      enabled: false

  alertmanager:
    enabled: false #true
#    config:
#      global:
#        resolve_timeout: 5m
#        smtp_smarthost: 'smtp.gmail.com:587'     # SMTP server and port
#        smtp_from: 'your-email@gmail.com'        # Sender email address
#        smtp_auth_username: 'your-email@gmail.com' # SMTP username
#        smtp_auth_password: 'your-app-password'    # SMTP password (or app password for Gmail)
#        smtp_require_tls: true
#      route:
#        receiver: 'default'
#        group_by: [ 'alertname' ]
#        group_wait: 10s
#        group_interval: 10s
#        repeat_interval: 1h
#      receivers:
#        - name: 'email-alerts'
#          email_configs:
#            - to: 'yourmail@gmail.com'
#              send_resolved: true

  serverFiles:
#    rules:
#      my_custom_alerts.yaml:
#        groups:
#          - name: failed-login-alerts
#            rules:
#              - alert: HighFailedLoginAttempts
#                expr: increase(failed_login_attempt_total[5m]) > 2
#                for: 2m
#                labels:
#                  severity: warning
#                annotations:
#                  summary: "High number of failed login attempts"
#                  description: "More than 2 failed login attempts detected in the last 5 minutes on instance {{ $labels.instance }}."
    prometheus.yml:
      scrape_configs:
        - job_name: 'accounts-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-accounts-service:8081' ]

        - job_name: 'bank-ui'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-bank-ui:8080' ]

        - job_name: 'blocker-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-blocker-service:8082' ]

        - job_name: 'cash-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-cash-service:8083' ]

        - job_name: 'exchange-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-exchange-service:8084' ]

        - job_name: 'exchange-generator-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-exchange-generator-service:8085' ]

        - job_name: 'gateway-api'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-gateway-api:8090' ]

        - job_name: 'notifications-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-notifications-service:8086' ]

        - job_name: 'transfer-service'
          metrics_path: '/actuator/prometheus'
          static_configs:
            - targets: [ 'bank-app-transfer-service:8087' ]

############################################ Grafana #############################################

bank-grafana:
  enabled: true

  adminUser: admin
  adminPassword: admin123

  service:
    type: ClusterIP
    port: 80

  persistence:
    enabled: false

  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      folder: /var/lib/grafana/dashboards
    datasources:
      enabled: true

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          access: proxy
          url: http://bank-app-bank-prometheus-server:80
          isDefault: true

  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/rewrite-target: /
    hosts:
      - "grafana.bank-app.local"
    path: "/grafana"